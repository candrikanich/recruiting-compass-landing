name: Auto Deploy to Staging

on:
  push:
    branches: [develop]

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - run: npm ci
      - run: npx nuxi prepare
      - run: npm run type-check
      - run: npm run lint
      - run: npm run build

  deploy:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm install -g vercel
      - run: |
          vercel deploy \
            --token="${{ secrets.VERCEL_TOKEN }}" \
            --scope="${{ secrets.VERCEL_ORG_ID }}"
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_STAGING }}
      - name: Slack Notification - Success
        if: success()
        continue-on-error: true
        uses: slackapi/slack-github-action@v2
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {"text":"✅ Landing Staging auto-deployed","blocks":[{"type":"section","text":{"type":"mrkdwn","text":"*✅ Landing Auto Deploy to Staging Success*\n*Commit:* ${{ github.sha }}"}}]}
      - name: Slack Notification - Failure
        if: failure()
        continue-on-error: true
        uses: slackapi/slack-github-action@v2
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {"text":"❌ Landing Staging auto-deploy failed","blocks":[{"type":"section","text":{"type":"mrkdwn","text":"*❌ Landing Auto Deploy to Staging Failed*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"}}]}
